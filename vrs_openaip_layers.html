<script type="text/javascript">
    // Configuração principal do OpenAIP
    const MAP_CONFIG = {
        openaip: {
            apiKey: 'YOU KEY',
            subdomains: ['a', 'b', 'c'],
            tileUrl: 'https://{s}.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png',
            options: {
                maxZoom: 14,
                attribution: '© OpenAIP Data - CC BY-NC 4.0',
                opacity: 0.8,
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=',
                detectRetina: false
            }
        },
        osm: {
            tileUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            options: {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }
        }
    };

    // Função para verificar disponibilidade do serviço OpenAIP
    async function checkServiceAvailability() {
        try {
            const testUrl = MAP_CONFIG.openaip.tileUrl
                .replace('{s}', MAP_CONFIG.openaip.subdomains[0])
                .replace('{z}/{x}/{y}', '6/32/22') +
                `?apiKey=${MAP_CONFIG.openaip.apiKey}`;

            const response = await fetch(testUrl, {
                method: 'HEAD',
                cache: 'no-store'
            });
            return response.ok;
        } catch (e) {
            console.warn('Serviço OpenAIP indisponível:', e);
            return false;
        }
    }

    // Inicialização no Virtual Radar Server
    if (VRS && VRS.globalDispatch) {
        VRS.globalDispatch.hook(VRS.globalEvent.bootstrapCreated, async function (bootStrap) {
            if (bootStrap.hookMapInitialised) {
                bootStrap.hookMapInitialised(async function (pageSettings) {
                    if (pageSettings.mapPlugin) {
                        const map = pageSettings.mapPlugin.getNative();

                        // Camada combinada OpenAIP
                        const openaipLayer = L.tileLayer(
                            MAP_CONFIG.openaip.tileUrl + `?apiKey=${MAP_CONFIG.openaip.apiKey}`,
                            {
                                ...MAP_CONFIG.openaip.options,
                                subdomains: MAP_CONFIG.openaip.subdomains
                            }
                        );

                        // Escurece os tiles inicialmente
                        openaipLayer.on('tileload', function (event) {
                            event.tile.style.filter = 'brightness(70%) contrast(110%)';
                        });

                        // Camada OSM (fallback)
                        const osmLayer = L.tileLayer(
                            MAP_CONFIG.osm.tileUrl,
                            MAP_CONFIG.osm.options
                        );

                        // Verifica disponibilidade do OpenAIP
                        const openaipAvailable = await checkServiceAvailability();

                        // Configuração das camadas de base
                        const baseLayers = {
                            'OpenStreetMap': osmLayer
                        };

                        if (openaipAvailable) {
                            baseLayers['OpenAIP (Camada Combinada)'] = openaipLayer;
                        }

                        // Controle de camadas
                        L.control.layers(baseLayers, {}, {
                            position: 'topright',
                            collapsed: false
                        }).addTo(map);

                        // Adiciona camadas padrão
                        osmLayer.addTo(map);
                        if (openaipAvailable) openaipLayer.addTo(map);

                        // Tratamento de erro no carregamento dos tiles
                        openaipLayer.on('tileerror', function (e) {
                            console.warn(`Erro ao carregar tile OpenAIP:`, e);
                            openaipLayer.setOpacity(openaipLayer.options.opacity * 0.3);
                        });

                        openaipLayer.on('tileload', function () {
                            openaipLayer.setOpacity(openaipLayer.options.opacity);
                        });

                        // Ajuste dinâmico de opacidade conforme zoom
                        map.on('zoomend', function () {
                            const currentZoom = map.getZoom();
                            if (currentZoom >= 14) {
                                openaipLayer.setOpacity(0.3);
                            } else {
                                openaipLayer.setOpacity(openaipLayer.options.opacity);
                            }
                        });

                        // === Controle customizado de contraste ===
                        if (openaipAvailable) {
                            const ContrastControl = L.Control.extend({
                                options: { position: 'topright' },
                                onAdd: function () {
                                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                                    container.style.background = '#fff';
                                    container.style.padding = '5px';
                                    container.style.width = '140px';
                                    container.style.fontSize = '12px';

                                    container.innerHTML = `
                                        <label>Contraste</label><br>
                                        <input id="contrastRange" type="range" min="50" max="150" value="100" step="5" style="width:100%">
                                    `;

                                    // Impede que o slider mexa no mapa ao arrastar
                                    L.DomEvent.disableClickPropagation(container);

                                    container.querySelector('#contrastRange').addEventListener('input', function (e) {
                                        const value = e.target.value;
                                        const brightness = 100 - (value - 100) * 0.3; 
                                        const contrast = value;
                                        document.querySelectorAll("img.leaflet-tile").forEach(tile => {
                                            if (tile.src.includes("openaip")) {
                                                tile.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
                                            }
                                        });
                                    });

                                    return container;
                                }
                            });

                            map.addControl(new ContrastControl());
                        }
                    }
                });
            }
        });
    }
</script>
